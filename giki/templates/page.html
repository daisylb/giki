<!doctype html>
<html>
	<head>
		<title>{{page.path}}</title>
		<link rel=stylesheet href='//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.0/css/bootstrap-combined.min.css'>
		<script type='text/css' src='http://code.jquery.com/jquery-1.8.1.min.js'></script>
		<script type='text/css' src='//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.0/js/bootstrap.min.js'></script>
		<script src='//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.1/jquery.min.js'></script>
		<script src='//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.1.1/bootstrap.min.js'></script>
		<script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
		<style type='text/css'>
			#editor {
				position: absolute;
				top: 0;
				bottom: 36px;
			}
			.breadcrumb {
				display: inline;
				background: none;
			}
			#top-row {
				padding: 10px 5px;
				margin: 5px 0;
				border: 1px solid #ddd;
				border-radius: 5px;
				vertical-align: middle;
			}
			#top-row button {
				position: relative;
				top: -5px;
			}
		</style>
	</head>
	<body>
		<div class='container'>
			<div id='wiki-view'>
				<div id='top-row'>
					<ul class="breadcrumb">
						<li><a href="/">{{default_page}}</a></li>
						{% for cpt in path_components %}
							<li>
								<span class="divider">/</span>
								<a href="/{{cpt.path}}">{{cpt.name}}</a>
							</li>
						{% endfor %}
					</ul>
					<span style='float: right;'>
						<button class='btn' onclick='edit();'>Edit</button>
					</span>
				</div>
				{{content}}
			</div>
			<div id='wiki-edit'>
				<form method=post id=editform class='form-horizontal'>
					<input type=hidden name='commit_id' value="{{page.commit_id}}">
					<div class='control-group'>
						<div id='editor' class=span12>{{page.content|escape}}</div>
					</div>
					<div id='edit-toolbar' class='navbar navbar-fixed-bottom'>
						<div class="navbar-inner">
							<div class='navbar-form container'>
								<div class='pull-right'>
									<input type=text name=commit_msg class='input-xxlarge' placeholder='Change description'>
									<button type=submit class='btn btn-primary' onclick="editing=false;">Save</button>
								</div>
								<button type=reset class='btn pull-left' onclick='view()'>Cancel</button>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
		<script>
			var editor = ace.edit('editor');
			editor.setTheme('ace/theme/chrome');
			editor.getSession().setMode('ace/mode/markdown');
			var editing = false;
			function refresh_view(){
				$('#wiki-view').toggle(!editing);
				$('#wiki-edit').toggle(editing);
				$('#edit-toolbar').toggle(editing);
				if (editing) editor.resize();
			}
			refresh_view();
			function view(){
				editing = false;
				refresh_view();
			}
			function edit(){
				editing = true;
				refresh_view();
			}
			function toggle_edit(){
				editing = !editing;
				refresh_view();
			}
			$('#editform').on('submit', function(){
				var textarea = $('<textarea name=content>');
				textarea.html(editor.getSession().getValue());
				textarea.css('display', 'none');
				$(this).append(textarea);
			});
			window.onbeforeunload = function(){
				if (editing){
					return "You have unsaved changes.";
				}
			}
		</script>
	</body>
</html>
